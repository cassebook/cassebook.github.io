<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Example to illustrate the benefit of using EDHMM over HMM, to fit temporally structured event patterns.</span>
<span class="c1">#</span>
<span class="c1"># Written by Dan Stowell 2016.</span>
<span class="c1">#</span>
<span class="c1"># To the extent possible under law, the author(s) have dedicated all copyright and related and neighboring rights to this software to the public domain worldwide. This software is distributed without any warranty.</span>
<span class="c1"># You should have received a copy of the CC0 Public Domain Dedication along with this software. If not, see &lt;http://creativecommons.org/publicdomain/zero/1.0/&gt;. </span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">pyhsmm</span>
<span class="kn">from</span> <span class="nn">pyhsmm.util.text</span> <span class="kn">import</span> <span class="n">progprint_xrange</span>
<span class="kn">from</span> <span class="nn">pyhsmm.util.general</span> <span class="kn">import</span> <span class="n">rle</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c1">#matplotlib.use(&#39;PDF&#39;) # http://www.astrobetter.com/plotting-to-a-file-in-python/</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">54321</span><span class="p">)</span>

<span class="c1">############################################################################</span>
<span class="c1"># a hand-made generative process for some data to analyse</span>
<span class="n">gen_dur</span> <span class="o">=</span> <span class="p">[</span>
	<span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
	<span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">),</span>
	<span class="p">]</span>

<span class="n">ndims</span> <span class="o">=</span> <span class="mi">10</span>    <span class="c1"># dimnality of observations</span>
<span class="k">if</span> <span class="n">ndims</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
	<span class="n">gen_obs</span> <span class="o">=</span> <span class="p">[</span>
		<span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
		<span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="mf">1.5</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
		<span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
	<span class="c1"># higher dim</span>
	<span class="n">tpl</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
	<span class="n">gen_obs</span> <span class="o">=</span> <span class="p">[</span>
		<span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span>                 <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">)]),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndims</span><span class="p">)),</span>
		<span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tpl</span><span class="p">[</span><span class="n">idx</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">tpl</span><span class="p">)]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">)]),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndims</span><span class="p">)),</span>
		<span class="p">]</span>

<span class="k">def</span> <span class="nf">sample_some_data</span><span class="p">(</span><span class="n">dur</span><span class="p">):</span>
	<span class="s2">&quot;Just samples from a simple binary EDHMM&quot;</span>
	<span class="n">ndims</span> <span class="o">=</span> <span class="n">gen_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndims</span><span class="p">))</span>
	<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">trueseq</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">while</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dur</span><span class="p">:</span>
		<span class="n">nextlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_dur</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">rvs</span><span class="p">())</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">gen_obs</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nextlen</span><span class="p">)))</span>
		<span class="n">trueseq</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">state</span><span class="p">]</span> <span class="o">*</span> <span class="n">nextlen</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">state</span>
	<span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">dur</span><span class="p">,</span> <span class="p">:]</span>
	<span class="n">trueseq</span> <span class="o">=</span> <span class="n">trueseq</span><span class="p">[:</span><span class="n">dur</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trueseq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">numframes</span> <span class="o">=</span> <span class="mi">4000</span>
<span class="n">data</span><span class="p">,</span> <span class="n">trueseq</span> <span class="o">=</span> <span class="n">sample_some_data</span><span class="p">(</span><span class="n">numframes</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&quot;data.shape: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>

<span class="n">myxlim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)</span>

<span class="c1">############################################################################</span>

<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">plot_slice</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span><span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">draw</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="n">update</span> <span class="o">=</span> <span class="n">update</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
	<span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span> <span class="k">if</span> <span class="n">fig</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_figure</span><span class="p">()</span>
	<span class="n">feature_ax</span><span class="p">,</span> <span class="n">stateseq_axs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axes</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

	<span class="n">sp1_artists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_observations</span><span class="p">(</span><span class="n">feature_ax</span><span class="p">,</span><span class="n">plot_slice</span><span class="o">=</span><span class="n">plot_slice</span><span class="p">,</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>

	<span class="n">feature_ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">))</span>
	<span class="n">feature_ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">))</span>

	<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stateseq_axs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_list</span><span class="p">)</span>
	<span class="n">sp2_artists</span> <span class="o">=</span> \
	    <span class="p">[</span><span class="n">artist</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states_list</span><span class="p">,</span><span class="n">stateseq_axs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">artist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_stateseq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">plot_slice</span><span class="p">,</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span><span class="n">draw</span><span class="o">=</span><span class="bp">False</span><span class="p">)]</span>

	<span class="k">if</span> <span class="n">draw</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

	<span class="k">return</span> <span class="n">sp1_artists</span> <span class="o">+</span> <span class="n">sp2_artists</span>

<span class="c1">############################################################################</span>
<span class="c1">#  posterior inference</span>

<span class="c1"># Set the weak limit truncation level</span>
<span class="n">Nmax</span> <span class="o">=</span> <span class="mi">2</span>   <span class="c1">#25    # NOTE: the Geom mismatch shows up as selecting lots of states if we allow it. alternatively, if we restrict to 2 we see the effect directly in the durations.</span>

<span class="c1"># and some hyperparameters</span>
<span class="n">obs_dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">obs_hypparams</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mu_0&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">obs_dim</span><span class="p">),</span>
                <span class="s1">&#39;sigma_0&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">obs_dim</span><span class="p">),</span>
                <span class="s1">&#39;kappa_0&#39;</span><span class="p">:</span><span class="mf">0.25</span><span class="p">,</span>
                <span class="s1">&#39;nu_0&#39;</span><span class="p">:</span><span class="n">obs_dim</span><span class="o">+</span><span class="mi">2</span><span class="p">}</span>
<span class="n">dur_hypparams_pois</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alpha_0&#39;</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span>     <span class="c1"># NOTE: the prior seems to have clear influence. the mean duration (alpha/beta) being 15 fits much better than 30.</span>
                 <span class="s1">&#39;beta_0&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
<span class="n">dur_hypparams_geom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alpha_0&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                 <span class="s1">&#39;beta_0&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span>

<span class="n">resultstore</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pois&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">]:</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&quot;=======================================&quot;</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running mode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

	<span class="n">obs_distns</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="o">**</span><span class="n">obs_hypparams</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmax</span><span class="p">)]</span>

	<span class="n">dur_distns</span> <span class="o">=</span> <span class="p">[</span>
		<span class="p">{</span>
			<span class="s1">&#39;pois&#39;</span><span class="p">:</span> <span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">PoissonDuration</span><span class="p">(</span><span class="o">**</span><span class="n">dur_hypparams_pois</span><span class="p">),</span>
			<span class="s1">&#39;geom&#39;</span><span class="p">:</span> <span class="n">pyhsmm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">GeometricDuration</span><span class="p">(</span><span class="o">**</span><span class="n">dur_hypparams_geom</span><span class="p">),</span>
		<span class="p">}[</span><span class="n">mode</span><span class="p">]</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmax</span><span class="p">)]</span>



	<span class="n">bestposteriormodel</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># we are re-running the model fit multiple times and keeping only the best</span>

		<span class="n">posteriormodel</span> <span class="o">=</span> <span class="n">pyhsmm</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">WeakLimitHDPHSMM</span><span class="p">(</span>
			<span class="n">alpha</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span> <span class="c1"># these can matter; see concentration-resampling.py</span>
			<span class="n">init_state_concentration</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span> <span class="c1"># pretty inconsequential</span>
			<span class="n">obs_distns</span><span class="o">=</span><span class="n">obs_distns</span><span class="p">,</span>
			<span class="n">dur_distns</span><span class="o">=</span><span class="n">dur_distns</span><span class="p">)</span>
		<span class="n">posteriormodel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">trunc</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="c1"># duration truncation speeds things up when it&#39;s possible</span>

		<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">progprint_xrange</span><span class="p">(</span><span class="mi">150</span><span class="p">):</span>
			<span class="n">posteriormodel</span><span class="o">.</span><span class="n">resample_model</span><span class="p">()</span>

		<span class="k">if</span> <span class="n">bestposteriormodel</span><span class="o">==</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">posteriormodel</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">bestposteriormodel</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">():</span>
			<span class="k">print</span><span class="p">(</span><span class="s2">&quot;We have a winner&quot;</span><span class="p">)</span>
			<span class="n">bestposteriormodel</span> <span class="o">=</span> <span class="n">posteriormodel</span>

	<span class="n">plot</span><span class="p">(</span><span class="n">bestposteriormodel</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

	<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

	<span class="n">thestateseq</span> <span class="o">=</span> <span class="n">bestposteriormodel</span><span class="o">.</span><span class="n">states_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stateseq</span>
	<span class="c1"># NOTE: here we fix the state-ambiguity by flipping the inferred state seq if it&#39;s become inverted</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thestateseq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
		<span class="n">thestateseq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">thestateseq</span>
	<span class="n">resultstore</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s1">&#39;stateseq&#39;</span><span class="p">:</span> <span class="n">thestateseq</span><span class="p">,</span>
		<span class="s1">&#39;rle&#39;</span><span class="p">:</span> <span class="n">rle</span><span class="p">(</span><span class="n">thestateseq</span><span class="p">),</span>
	<span class="p">}</span>

<span class="c1"># add &#39;true&#39; to resultstore as if it were a result!</span>
<span class="n">resultstore</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s1">&#39;stateseq&#39;</span><span class="p">:</span> <span class="n">trueseq</span><span class="p">,</span>
	<span class="s1">&#39;rle&#39;</span><span class="p">:</span> <span class="n">rle</span><span class="p">(</span><span class="n">trueseq</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1">##############################################################################</span>

<span class="c1">#print resultstore</span>
<span class="c1">#print trueseq</span>

<span class="n">modelist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;pois&#39;</span><span class="p">]</span>
<span class="n">modedata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s1">&#39;true&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lbl&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span>            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">},</span>
	<span class="s1">&#39;pois&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lbl&#39;</span><span class="p">:</span> <span class="s1">&#39;EDHMM&#39;</span> <span class="c1"># (Poisson)&#39;</span>
		<span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">},</span>
	<span class="s1">&#39;geom&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lbl&#39;</span><span class="p">:</span> <span class="s1">&#39;HMM&#39;</span><span class="p">,</span>             <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">:</span> <span class="s1">&#39;-.&#39;</span><span class="p">},</span>
<span class="p">}</span>


<span class="n">pdf</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s1">&#39;edhmm_example_fit.pdf&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_my_timeline</span><span class="p">(</span><span class="n">aseq</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">aseq</span><span class="p">[</span><span class="s1">&#39;stateseq&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
	<span class="k">elif</span> <span class="bp">False</span><span class="p">:</span>
		<span class="n">cumpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">aseq</span><span class="p">[</span><span class="s1">&#39;rle&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">whichpos</span><span class="p">,</span> <span class="p">(</span><span class="n">stateval</span><span class="p">,</span> <span class="n">adur</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">aseq</span><span class="p">[</span><span class="s1">&#39;rle&#39;</span><span class="p">])):</span>
			<span class="k">if</span> <span class="n">stateval</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">cumpos</span><span class="p">[</span><span class="n">whichpos</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cumpos</span><span class="p">[</span><span class="n">whichpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">adur</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aseq</span><span class="p">[</span><span class="s1">&#39;stateseq&#39;</span><span class="p">])),</span> <span class="n">aseq</span><span class="p">[</span><span class="s1">&#39;stateseq&#39;</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>

	<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
	<span class="k">if</span> <span class="n">myxlim</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">myxlim</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numframes</span><span class="p">)</span>

<span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ndims</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
		<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>  <span class="mi">5</span><span class="p">)</span>
		<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.15</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Accent&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">myxlim</span><span class="p">:</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">myxlim</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">whichmode</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modelist</span><span class="p">):</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="n">whichmode</span><span class="p">)</span>
	<span class="n">plot_my_timeline</span><span class="p">(</span><span class="n">resultstore</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;lbl&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (frames)&quot;</span><span class="p">)</span>

<span class="c1"># a histogram of the true and the inferred state durations encountered, separately for the on and the off states (therefore two plots, each with 3 &quot;transparent&quot; histograms on)</span>
<span class="k">for</span> <span class="n">whichsubplot</span><span class="p">,</span> <span class="n">whichstate</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">whichsubplot</span><span class="p">)</span>
	<span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
		<span class="n">durscollected</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">whichmode</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modelist</span><span class="p">):</span>
			<span class="n">durscollected</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">adur</span> <span class="k">for</span> <span class="n">stateval</span><span class="p">,</span> <span class="n">adur</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">resultstore</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;rle&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">stateval</span><span class="o">==</span><span class="n">whichstate</span><span class="p">])</span>

		<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">durscollected</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;lbl&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modelist</span><span class="p">],</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1">#, histtype=&#39;step&#39;)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">whichmode</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modelist</span><span class="p">):</span>
			<span class="n">binclump</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">][</span><span class="n">whichstate</span><span class="p">]</span>
			<span class="n">plotdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">adur</span><span class="o">/</span><span class="n">binclump</span><span class="p">))</span> <span class="k">for</span> <span class="n">stateval</span><span class="p">,</span> <span class="n">adur</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">resultstore</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;rle&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">stateval</span><span class="o">==</span><span class="n">whichstate</span><span class="p">])</span>
			<span class="n">plotdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)</span>
			<span class="n">plotdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">plotdata</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plotdata</span><span class="p">))</span><span class="o">*</span><span class="n">binclump</span><span class="p">,</span> <span class="n">plotdata</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plotdata</span><span class="p">))</span><span class="o">*</span><span class="n">binclump</span><span class="p">,</span> <span class="n">plotdata</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;lbl&#39;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">modedata</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

	<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative frequency&#39;</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Empirical durations of </span><span class="si">%s</span><span class="s2"> periods (frames)&quot;</span> <span class="o">%</span> <span class="p">[</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">][</span><span class="n">whichstate</span><span class="p">])</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="c1">#plt.show()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</body>
</html>
